<script>
    // === REMARK: ใส่ URL ของ Web App Google Apps Script ตรงนี้ ===
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw7Y8FQubHXFVE7LPn1GKTTfbMqSpK2JBUKtdwU56ou8v7pWoZlxuBXC4sLjKZ88XnL/exec';

    const reportForm = document.getElementById('report-form');
    const submitButton = document.getElementById('submit-button');
    const statusMessage = document.getElementById('status-message');

    let isSubmitting = false;
    let qrCodeValue = ''; // ค่าที่ได้จากการสแกน

    const displayMessage = (message, type = 'success') => {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800');
        if (type === 'success') {
            statusMessage.classList.add('bg-green-200', 'text-green-800');
        } else {
            statusMessage.classList.add('bg-red-200', 'text-red-800');
        }
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    };

    reportForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('id-input').value;
        const report = document.getElementById('report-input').value;
        const imageFile = document.getElementById('image-input').files[0];

        if (!id || !report || !imageFile) {
            displayMessage('กรุณากรอกข้อมูลและเลือกรูปภาพให้ครบถ้วน', 'error');
            return;
        }

        if (!qrCodeValue) {
            displayMessage('กรุณาสแกน QR Code ก่อน', 'error');
            return;
        }

        if (isSubmitting) return;
        isSubmitting = true;
        submitButton.textContent = 'กำลังส่ง...';
        submitButton.disabled = true;

        try {
            // ดึงพิกัด GPS
            const coords = await new Promise((resolve, reject) => {
                if (!('geolocation' in navigator)) {
                    reject('เบราว์เซอร์ไม่รองรับ Geolocation');
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({ latitude: position.coords.latitude, longitude: position.coords.longitude }),
                    (error) => reject(`ไม่สามารถระบุตำแหน่ง GPS ได้ (${error.message})`),
                    { timeout: 5000 }
                );
            });

            // === แปลงรูปภาพเป็น Base64 ===
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1]; // ตัด prefix ออก

                const formData = new FormData();
                formData.append('id', id);
                formData.append('qrcodeValue', qrCodeValue);
                formData.append('latitude', coords.latitude);
                formData.append('longitude', coords.longitude);
                formData.append('report', report);
                formData.append('image', base64Data); // ✅ ส่ง Base64 ไป

                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    displayMessage('ส่งข้อมูลสำเร็จแล้ว', 'success');
                    reportForm.reset();
                } else {
                    displayMessage(`เกิดข้อผิดพลาด: ${result.message}`, 'error');
                }

                isSubmitting = false;
                submitButton.textContent = 'ส่งข้อมูล';
                submitButton.disabled = false;
            };

            reader.readAsDataURL(imageFile);

        } catch (error) {
            console.error('Error during submission:', error);
            displayMessage(`เกิดข้อผิดพลาด: ${error}`, 'error');
            isSubmitting = false;
            submitButton.textContent = 'ส่งข้อมูล';
            submitButton.disabled = false;
        }
    });
</script>
