<script>
  // === REMARK: ใส่ URL ของ Web App (GAS) ตรงนี้ ===
  const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwfIiffw5Lt2mcgkkDYtYAP21shDQhRcn2DgcxKajuCVnDg8DpXrSyoAPYNVeIgTDV8/exec'; // REMARK: ใส่ GAS Web App URL

  // อ้างอิง DOM
  const reportForm = document.getElementById('report-form');
  const submitButton = document.getElementById('submit-button');
  const statusMessage = document.getElementById('status-message');

  // ใช้ตัวแปร qrCodeValue จากสคริปต์สแกนเดิม ห้ามประกาศซ้ำ!
  // let qrCodeValue;  // ❌ อย่าประกาศซ้ำ

  let isSubmitting = false;

  const displayMessage = (message, type = 'success') => {
    statusMessage.textContent = message;
    statusMessage.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800');
    statusMessage.classList.add(type === 'success' ? 'bg-green-200' : 'bg-red-200');
    statusMessage.classList.add(type === 'success' ? 'text-green-800' : 'text-red-800');
    setTimeout(() => statusMessage.classList.add('hidden'), 5000);
  };

  reportForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('id-input').value.trim();
    const report = document.getElementById('report-input').value.trim();
    const imageFile = document.getElementById('image-input').files[0];

    if (!id || !report || !imageFile) {
      displayMessage('กรุณากรอกข้อมูลและเลือกรูปภาพให้ครบถ้วน', 'error');
      return;
    }
    if (!qrCodeValue) {
      displayMessage('กรุณาสแกน QR Code ก่อน', 'error');
      return;
    }
    if (isSubmitting) return;
    isSubmitting = true;
    submitButton.textContent = 'กำลังส่ง...';
    submitButton.disabled = true;

    try {
      // พยายามดึงพิกัด แต่ถ้าไม่ได้ ให้ส่ง N/A
      const coords = await new Promise((resolve) => {
        if (!('geolocation' in navigator)) return resolve({ latitude: 'N/A', longitude: 'N/A' });
        const to = setTimeout(() => resolve({ latitude: 'N/A', longitude: 'N/A' }), 5000);
        navigator.geolocation.getCurrentPosition(
          (pos) => { clearTimeout(to); resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }); },
          ()    => { clearTimeout(to); resolve({ latitude: 'N/A', longitude: 'N/A' }); },
          { timeout: 5000 }
        );
      });

      // แปลงรูปเป็น Base64 (ตัด prefix ทิ้งตอนส่ง)
      const toBase64 = (file) => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
      const dataUrl = await toBase64(imageFile);
      const base64Only = dataUrl.split(',')[1];

      // payload แบบ JSON
      const payload = {
        id,
        qrcodeValue: qrCodeValue,
        latitude: coords.latitude,
        longitude: coords.longitude,
        report,
        image: base64Only,
        filename: imageFile.name,
        mimeType: imageFile.type
      };

      const resp = await fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }, // ส่ง JSON
        body: JSON.stringify(payload)
      });
      const result = await resp.json();

      if (result.status === 'success') {
        displayMessage('ส่งข้อมูลสำเร็จแล้ว', 'success');
        reportForm.reset();
      } else {
        displayMessage(`เกิดข้อผิดพลาด: ${result.message}`, 'error');
      }
    } catch (err) {
      console.error(err);
      displayMessage(`เกิดข้อผิดพลาดในการส่งข้อมูล: ${err}`, 'error');
    } finally {
      isSubmitting = false;
      submitButton.textContent = 'ส่งข้อมูล';
      submitButton.disabled = false;
    }
  });
</script>
